<script>
  const channelId = 3160844;
  const fields = [1, 2, 3];

  async function fetchLastEntry() {
    const url = `https://api.thingspeak.com/channels/${channelId}/feeds/last.json`;
    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}&t=${Date.now()}`;

    const response = await fetch(proxy);
    if (!response.ok) throw new Error("HTTP " + response.status);

    let data;
    try {
      data = await response.json();
    } catch (e) {
      throw new Error("La respuesta de ThingSpeak no es válida");
    }

    if (!data || Object.keys(data).length === 0) {
      throw new Error("Sin datos disponibles");
    }

    return data;
  }

  function render(entry) {
    const container = document.getElementById("values");
    container.innerHTML = "";

    fields.forEach(f => {
      const value = entry[`field${f}`] ?? "—";
      const div = document.createElement("div");
      div.className = "stat";
      div.innerHTML = `
        <div class='stat-label'>Field ${f}</div>
        <div class='stat-value'>${value}</div>
      `;
      container.appendChild(div);
    });

    document.getElementById("timestamp").textContent =
      "Hora: " + new Date(entry.created_at).toLocaleString();
  }

  function showError(message) {
    document.getElementById("values").innerHTML = "";
    document.getElementById("timestamp").textContent = "";

    const box = document.getElementById("errorBox");
    if (box) {
      box.textContent = "⚠️ " + message;
      box.style.display = "block";
    } else {
      // por si no existe el div, lo creamos automáticamente
      const div = document.createElement("div");
      div.id = "errorBox";
      div.style.background = "#fee2e2";
      div.style.color = "#991b1b";
      div.style.padding = "12px";
      div.style.marginTop = "16px";
      div.style.borderRadius = "8px";
      div.style.textAlign = "center";
      div.textContent = "⚠️ " + message;
      document.querySelector(".card").appendChild(div);
    }
  }

  async function update() {
    try {
      const last = await fetchLastEntry();
      showError(""); // oculta error si lo había
      const box = document.getElementById("errorBox");
      if (box) box.style.display = "none";
      render(last);
    } catch (err) {
      showError(err.message);
    }
  }

  update();
  setInterval(update, 60000);
</script>
